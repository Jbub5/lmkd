{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "31041a49_46cb4d72",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 1741425
      },
      "writtenOn": "2021-08-27T22:01:19Z",
      "side": 1,
      "message": "LGTM. Just a question: when your experiment set multiple flags, do you expect lmkd to reinit once for all or multiple times? There seems either a reinit race or storm if those properties are changed at the same time.",
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4f4c174f_c909d293",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-08-27T22:05:45Z",
      "side": 1,
      "message": "I didn\u0027t try setting multiple flags at the same time. I think lmkd might restart multiple times the first time they are set but after that, since these properties persist, it won\u0027t need any more restarting?\nLet me check though what happens when I set several properties.",
      "parentUuid": "31041a49_46cb4d72",
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "adb55b6f_c9ea121d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 7
      },
      "lineNbr": 0,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-08-27T22:10:49Z",
      "side": 1,
      "message": "Ok, yes lmkd will restart on each property reset, however after they are set any further request to set a property to the same value is ignored and since these properties are persistent, this flood will happen only the first time experiment starts.",
      "parentUuid": "4f4c174f_c909d293",
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "25a99f01_e68489eb",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1275554
      },
      "writtenOn": "2021-08-30T21:16:03Z",
      "side": 1,
      "message": "I guess Suren already considered how we could make this bette like this but there was no good way to make it simple:\n\non property:persist.device_config.lmkd_native.*\u003d*\n   setprop lmkd.reinit 1\n   \nJust in case: Let me Cc Wei since he might know some way.\n\nIf we don\u0027t have better way, at least please put some comments on lmkd.cpp not to forget to update this rc file whenever we add new konbs.",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "46272169_3c7aa39a",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-08-31T03:32:27Z",
      "side": 1,
      "message": "Yes, I checked with Tom Cherry and he told me init language does not support such construct, but that would have been nice :)",
      "parentUuid": "25a99f01_e68489eb",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "82f4bd9a_95f1e311",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1105075
      },
      "writtenOn": "2021-08-31T05:07:54Z",
      "side": 1,
      "message": "yes, init doesn\u0027t support this yet.\n\nbut do we actually restart lmkd every boot after we have those persist property?\n\n\nshall we avoid the reinit by by using trampoline propriety or maybe a explicit property to reinit?\nso on experiment, we only set the trampoline which then set the persist property OR set the reinit flag everytime in the experiment?",
      "parentUuid": "46272169_3c7aa39a",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f69bd137_f58b569f",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-08-31T16:16:13Z",
      "side": 1,
      "message": "re: but do we actually restart lmkd every boot after we have those persist property?\n\nNo. Actually the new lmkd instance simply sends a request to the original lmkd to call its update_props() and exits. Original lmkd simply updates its tuning by re-reading the properties.\n\nre: shall we avoid the reinit by by using trampoline propriety or maybe a explicit property to reinit? so on experiment, we only set the trampoline which then set the persist property OR set the reinit flag everytime in the experiment?\n\nI did not get your idea. AFAIU experiments simply set the persistent property associated with experiment flag. If multiple flags are set then multiple persistent properties will be updated. We don\u0027t really know which properties will be set by the experiment and which one will be set the last, so we can\u0027t optimize the reinit process to trigger only once.\nFrankly, I don\u0027t see the point of optimizing the number of times we reinit lmkd. It happens only once, when experiment starts, persistent properties are set and do not change until another experiment or until experiment ends. Do we want to introduce more complexity simply to optimize something which happens once in a blue moon and has no side-effects?",
      "parentUuid": "82f4bd9a_95f1e311",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "79a8793d_946d970e",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-08-31T16:21:46Z",
      "side": 1,
      "message": "re: If we don\u0027t have better way, at least please put some comments on lmkd.cpp not to forget to update this rc file whenever we add new konbs.\n\nDone.",
      "parentUuid": "f69bd137_f58b569f",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "67ebdc6d_3ae8ab2e",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1275554
      },
      "writtenOn": "2021-08-31T16:58:23Z",
      "side": 1,
      "message": "note: I was totally missing something here since I am really poor how the Android property works so goes dumb comments.\n\nIIUC, I guess what Wei suggested doesn\u0027t aim for optimizing performance but wanted to have more simple code to be maintained.  \n\nIf we have explicit lmkd.reinit property instead of auto updating following changing one of tune, the lmkd.rc file would be clear without introducing additional property whenever we add new knob?\n\nWhat I means is experimental can do like this\n\nset_lmkd_property_A\nset_lmkd_property_B\nset_lmkd_property_C\nset_lmkd_reinit -\u003e so finally, lmkd will update his property with new ones.\n\nWith that, we don\u0027t need to have those implicit property update.\nIs there any problem here?",
      "parentUuid": "79a8793d_946d970e",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9dd9830b_86b7881b",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-08-31T17:10:26Z",
      "side": 1,
      "message": "The problem here is that experiment infrastructure does not work like that. You simply specify flags which map to system properties and when a flag is changed in the experiment the system properties are changed on the devices participating in the experiment.\n\nFor your suggestion to work we would have to add a new flag lmkd_reinit which is not really a tuning flag but is used to trigger lmkd reinit, and we have to ensure it is set the last. I don\u0027t think experiments infra supports such ordering and I don\u0027t think supporting this solution is the right direction. If anything, I would prefer for init language to support:\n\non property:persist.device_config.lmkd_native.*\n\nsyntax. So, if we want to improve this, let\u0027s expand the init language rather than find workarounds. This can be done in parallel with these changes to enable experiments, so I want to enable experiments with the current language and then we can change it after init supports the better alternative.",
      "parentUuid": "67ebdc6d_3ae8ab2e",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "da629b39_43f06d00",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1275554
      },
      "writtenOn": "2021-08-31T17:54:48Z",
      "side": 1,
      "message": "I am rather surprised if the infra doesn\u0027t care about ordering. Then, how can infra work if we want to update several params in order? Because I believe it\u0027s popular pattern to update params one by one(but not yet committed) and then finally commit when user set the all params.\n\nI don\u0027t think it\u0027s workaround. Rather than that, it\u0027s more clear pattern to be able to commit several params at the same time without any race.\n\nSince Infra doesn\u0027t work like that(don\u0027t care about metric update ordering) as Suren pointed out, I\u0027m totally fine with this approach but wanted to say it\u0027s not workaround.",
      "parentUuid": "9dd9830b_86b7881b",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dce3cc27_fa58073b",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1105075
      },
      "writtenOn": "2021-08-31T17:55:29Z",
      "side": 1,
      "message": "\u003e I did not get your idea. AFAIU experiments simply set the persistent property associated with experiment flag. If multiple flags are set then multiple persistent properties will be updated. We don\u0027t really know which properties will be set by the experiment and which one will be set the last, so we can\u0027t optimize the reinit process to trigger only once.\nFrankly, I don\u0027t see the point of optimizing the number of times we reinit lmkd. It happens only once, when experiment starts, persistent properties are set and do not change until another experiment or until experiment ends. Do we want to introduce more complexity simply to optimize something which happens once in a blue moon and has no side-effects?\n\n\nIs the the persist property trigger happens before or after lmkd starts?\n\nIf it happens after, does it mean now for every boot we need reinit lmk?",
      "parentUuid": "9dd9830b_86b7881b",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c0ba83b2_785cdff6",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-08-31T18:04:41Z",
      "side": 1,
      "message": "Once a persisten property is changed to a new value the lmkd reinit will be triggered. That new values is stored and persists after the boot. After that even if that property changes to the same value again, the \"on property\" will not trigger because it\u0027s the same value. So, unless we are changing the experiment, reinit will not happen even after reboot.",
      "parentUuid": "dce3cc27_fa58073b",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fe81768f_dc1f165c",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1105075
      },
      "writtenOn": "2021-08-31T20:49:26Z",
      "side": 1,
      "message": "+Tom\nNo, I think init will queue the trigger for every boot.",
      "parentUuid": "c0ba83b2_785cdff6",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "83416ab6_206275b3",
        "filename": "lmkd.rc",
        "patchSetId": 7
      },
      "lineNbr": 45,
      "author": {
        "id": 1105075
      },
      "writtenOn": "2021-08-31T20:51:27Z",
      "side": 1,
      "message": "i think init will queue the property triggers when it first loads those, from system/ vendor/ or data/",
      "parentUuid": "fe81768f_dc1f165c",
      "range": {
        "startLine": 15,
        "startChar": 0,
        "endLine": 45,
        "endChar": 25
      },
      "revId": "4c0e202f43983a03a58a3d4ae6bca7d61d9988c0",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}