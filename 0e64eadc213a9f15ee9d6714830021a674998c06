{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "d5a12c4f_4c1035a0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1741425
      },
      "writtenOn": "2021-09-01T15:26:36Z",
      "side": 1,
      "message": "I\u0027d argue that this CL is not necessary at all. When the server pushes new flags to the device, the device already boots, so boot_completed is always 1. The logic reinit\u003d${boot_completed:-0} never has a chance to set reinit to 0.",
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8830ac8c_97f185f0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1741425
      },
      "writtenOn": "2021-09-01T15:29:44Z",
      "side": 1,
      "message": "Well, I think I misunderstood the purpose of this CL. It\u0027s not for the moment the flags are pushed to the device, but for the reboot following that. Then it looks good to me.",
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2a7cb17e_87338d36",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-09-01T15:46:07Z",
      "side": 1,
      "message": "Correct. This is to prevent multiple reinits when persistent properties are being loaded at boot time. So we postpone reinit until the boot is done and if any relevant property got changed then lmk.reinit will be 0 and we will execute lmkd reinit only one time.",
      "parentUuid": "8830ac8c_97f185f0",
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "19dd2c73_287cb82c",
        "filename": "lmkd.rc",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1105075
      },
      "writtenOn": "2021-09-01T16:31:37Z",
      "side": 1,
      "message": "do we have a chance experiments will change those persist property before boot_complete?\n\nif not, we can save the reinit even it is just once so that we can just do\n\non property:sys.boot_completed\u003d1 \u0026\u0026 property:persist.device_config.lmkd_native.debug\u003d*\n    setprop lmkd.reinit 1",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 25
      },
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a25997e7_ed047ac6",
        "filename": "lmkd.rc",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1105075
      },
      "writtenOn": "2021-09-01T16:31:37Z",
      "side": 1,
      "message": "do we have a chance experiments will change those persist property before boot_complete?\n\nif not, we can save the reinit (even it is just once, as lmkd will try to load from psrsist if it exists) so that we can just do\n\non property:sys.boot_completed\u003d1 \u0026\u0026 property:persist.device_config.lmkd_native.debug\u003d*\n    setprop lmkd.reinit 1",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 25
      },
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c1b077b2_1641592d",
        "filename": "lmkd.rc",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-09-01T16:42:39Z",
      "side": 1,
      "message": "re: do we have a chance experiments will change those persist property before boot_complete?\nShort answer: Yes\n\nLong answer:\nThese persist properties change in 2 scenarios:\n1. When experiment is activated during device usual operation.\n2. During late-init when it calls load_persist_props. At this point lmkd is already active (by design) and will respond to these property changes.\n\nIn the case 1, setprop lmkd.reinit ${sys.boot_completed:-0} rule will set lmkd.reinit\u003d1 and this will result in an immediate lmkd reinitialization.\n\nIn the case 2, setprop lmkd.reinit ${sys.boot_completed:-0} rule sets lmkd.reinit\u003d0 to delay reinitialization and after boot completes and sys.boot_completed is set to 1, we will reinitialize lmkd one time only.\n\nSo, to answer your question, if these properties are changed before boot_complete, that is the case 2. In this case we set lmkd.reinit\u003d0 and wait for boot to complete and reinitialize lmkd after that.\n\n\nre: we can just do\non property:sys.boot_completed\u003d1 \u0026\u0026 property:persist.device_config.lmkd_native.debug\u003d*\n    setprop lmkd.reinit 1\n\nThis would miss the case when persist.device_config.lmkd_native.* changes while sys.boot_completed\u003d0.",
      "parentUuid": "19dd2c73_287cb82c",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 25
      },
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "203c1d2e_1c2972d5",
        "filename": "lmkd.rc",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1105075
      },
      "writtenOn": "2021-09-01T18:29:46Z",
      "side": 1,
      "message": "\u003eThis would miss the case when persist.device_config.lmkd_native.* changes while sys.boot_completed\u003d0.\n\nyes, as I mentioned, do we have a case this can happen? experiments depends on GMScore, which should only happen after boot_complet, right?",
      "parentUuid": "c1b077b2_1641592d",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 25
      },
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "95856d43_ff0f99e8",
        "filename": "lmkd.rc",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1105075
      },
      "writtenOn": "2021-09-01T18:32:03Z",
      "side": 1,
      "message": "I understand your change, just feel we may not have the case you are trying to cover here.",
      "parentUuid": "203c1d2e_1c2972d5",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 25
      },
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4e260f52_9dd5ab99",
        "filename": "lmkd.rc",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-09-01T21:42:23Z",
      "side": 1,
      "message": "Which case? When persistent properties are set during boot? We definitely have that case if any experiment is being run and device reboots. You can verify it by running the same test I described in the \"Test:\" section:\n\nadb shell device_config put lmkd_native thrashing_limit_critical 350\nadb shell device_config put lmkd_native thrashing_limit 100\nadb reboot\nadb -b all logcat | grep lmkd\n\nWithout this patch you will see lmkd being reinitialize multiple times during boot. With this patch you will see only one initialization at the end of the boot complete. Reasons why pesistent properties are being set during boot I already explained in my previous reply.",
      "parentUuid": "95856d43_ff0f99e8",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 25
      },
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "6d754aea_6254d096",
        "filename": "lmkd.rc",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1105075
      },
      "writtenOn": "2021-09-01T22:15:43Z",
      "side": 1,
      "message": "it looks like we started lmkd quite earlier, on `init` trigger\n\nso that was the confusion.\n\nMaybe we can move the \"on init\" stuff here.",
      "parentUuid": "4e260f52_9dd5ab99",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 25
      },
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "17c70880_bcad346f",
        "filename": "lmkd.rc",
        "patchSetId": 1
      },
      "lineNbr": 15,
      "author": {
        "id": 1105075
      },
      "writtenOn": "2021-09-01T22:15:43Z",
      "side": 1,
      "message": "same",
      "parentUuid": "a25997e7_ed047ac6",
      "range": {
        "startLine": 13,
        "startChar": 0,
        "endLine": 15,
        "endChar": 25
      },
      "revId": "0e64eadc213a9f15ee9d6714830021a674998c06",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}