{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "c81e678e_80570820",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1275554
      },
      "writtenOn": "2021-05-28T01:46:12Z",
      "side": 1,
      "message": "First of all, Thanks Suren, It would be really useful. \n\nI\u0027d like to clarify my understanding about duplicated memory accouting.\n\nGPU memory LMKD reported by this CL is subpart of /sys/kernel/dma_heap/total_pools_kb in previous patch? \n\nIOW, it could be wrong if I use this expression to get LostRAM from killinfo\n\nanon_lru + file_lru + kstack + slab + zram + total_pools_kb from dma_heap + *gpu* + and so on \n\nInstead should I use?\n\nMEMINFO - (anon_lru + file_lru + kstack + slab + zram + total_pools_kb + and so on) \u003d \n\n",
      "revId": "8d046b10b07442c4309cb4e7c827011f13395a8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0bf37b43_ab231e18",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-05-28T02:01:58Z",
      "side": 1,
      "message": "Not quite. Total GPU includes:\nprivate allocations by GPU driver (alloc_pages/kmalloc/etc)\ndmabufs exported by GPU driver\n\nSo there is an overlap between dmabuf heaps and GPU (some dmabufs from dmabuf heaps are also included in total GPU).\nHowever there is no overlap between GPU total and dmabuf heap pools because pools contain only buffers which are currently unused. Bootcamp presentation at https://docs.google.com/presentation/d/1hhYa_HwMfYRGg3qucy9Q7ZvjCRUFcFDbjgApdMnARuo/edit#slide\u003did.gce33650f2b_0_0 describes this on pages 11-12.",
      "parentUuid": "c81e678e_80570820",
      "revId": "8d046b10b07442c4309cb4e7c827011f13395a8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "49c5e2d8_70b8e33e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-05-28T02:03:34Z",
      "side": 1,
      "message": "Correction:\n\nTotal GPU includes:\nprivate allocations by GPU driver (alloc_pages/kmalloc/etc)\ndmabufs mapped by GPU driver",
      "parentUuid": "0bf37b43_ab231e18",
      "revId": "8d046b10b07442c4309cb4e7c827011f13395a8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "10883b1d_f6cfbbb6",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1275554
      },
      "writtenOn": "2021-05-28T03:18:57Z",
      "side": 1,
      "message": "private allocation by GPU driver (alloc_pages/kmalloc/etc).\n\n- That(kmalloc) means they are double accounted by slab. \n\ndmabufs mapped by GPU driver\n\n- They are double accounted by dmabuf.\n\nThe legacy I added ION in vmstat and gpu in mm_event was never double accounted since I only accounted them on the alloc_pages in each driver. \n\nCan we have like this?\n\ndmabuf private heap + gpu private so their sum is never overlap with other statistics so it\u0027s much clear to sum up the final memory consumption snapshot based on system total memory.\n\nEither combination is fine if we could remove the duplication, please.",
      "parentUuid": "49c5e2d8_70b8e33e",
      "revId": "8d046b10b07442c4309cb4e7c827011f13395a8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9bb363fa_14932d73",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-05-28T16:23:39Z",
      "side": 1,
      "message": "I\u0027m likely wrong about kmallocs from GPU driver. Need to double check with Yiwei. I think only large allocations are traced and included in BPF map. I doubt GPU would use kmalloc for large allocations.\n\nRemoving duplication between GPU dmabuf mapped buffers and the same buffers in dmabuf heaps is non-trivial task as I mentioned before and involves dmabuf sysfs traversal and access to memtrack HAL, so unfortunately I don\u0027t think LMKD can afford to do that.",
      "parentUuid": "10883b1d_f6cfbbb6",
      "revId": "8d046b10b07442c4309cb4e7c827011f13395a8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ff4b38ba_c9bd930a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1323232
      },
      "writtenOn": "2021-05-30T16:57:48Z",
      "side": 1,
      "message": "To clarify, does /sys/kernel/dma_heap/total_pools_kb only report dma heap pool (NOT mapped) size? and in this patch, we get GPU private and bmabufs mapped by GPU buffers. If so, the only thing overlap is kmalloc which needs to check with Yiwei, right? Thanks.",
      "parentUuid": "9bb363fa_14932d73",
      "revId": "8d046b10b07442c4309cb4e7c827011f13395a8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9bf9344b_053e1741",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-05-30T19:21:53Z",
      "side": 1,
      "message": "Yes, total_pools_kb represents memory in dmabuf pools - buffers allocated but currently unused. GPU allocation include GPU private allocations + dmabufs mapped by GPU driver. So there is overlap between dmabuf hueaps (not reported here) and total GPU allocations, but there is no overlap between GPU allocations and dmabuf heap pools reported here.",
      "parentUuid": "ff4b38ba_c9bd930a",
      "revId": "8d046b10b07442c4309cb4e7c827011f13395a8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c21cc421_6e94e5c1",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1323232
      },
      "writtenOn": "2021-05-31T13:44:36Z",
      "side": 1,
      "message": "Thanks,Suren. One more question. Does all mapped dmabufs are managed(mapped) by GPU driver? If not, we might miss something mapped dmabufs which are not mapped by GPU driver, right?\n\nI saw Minchan is exporting used dma_buf size(pa/1937168). If we log it, we could have some idea if GPU is using a lot of memory even thought they are double accounting. Is my understanding correct? \n\nex.\nDMA_USED is 1G and GPU_TOTAL is 1.2G so we could guess most of used(mapped) dma_buf come from GPU side.",
      "parentUuid": "9bf9344b_053e1741",
      "revId": "8d046b10b07442c4309cb4e7c827011f13395a8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6e93cbf1_f0a8bfd5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1157738
      },
      "writtenOn": "2021-05-31T18:40:40Z",
      "side": 1,
      "message": "No, not all dmabufs are mapped by GPU driver, some are used for other purposes. And yes, we will miss some dmabufs which are used but not by GPU driver.\n\nI also just noticed pa/1937168 and that would expose the total dmabuf size I think (Hridya would be the best person to review this CL and also decide whether it can be upstreamed). If it gets accepted I would like to report this number under MI_ION_HEAP.\n\nBut as Minchan noted, even in that case MI_ION_HEAP and GPU categories will have some overlap which is not easy to calculate (it requires walking dmabuf sysfs hierarchy and also having access to memtrack HAL to obtain GPU device name).",
      "parentUuid": "c21cc421_6e94e5c1",
      "revId": "8d046b10b07442c4309cb4e7c827011f13395a8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}